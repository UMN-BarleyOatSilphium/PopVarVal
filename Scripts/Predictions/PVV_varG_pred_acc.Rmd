---
title: "PVV Validation Analysis"
output: html_notebook
---

This notebook will look at the prediction accuracy of $\simga^2_{G(m)}$ and $\mu_{SP(m)}$ in the PopVarVal project

## Introduction

```{r setup}

library(tidyverse)
library(lme4)
library(modelr)
library(readxl)
library(stringr)
library(broom)
library(pbr)
library(purrrlyr)
library(boot)

# Project directory
proj_dir <- "C:/Users/Jeff/Google Drive/Barley Lab/Projects/PopVarVal/"

proj_pheno_dir <- file.path(proj_dir, "Phenotypic_Data")
result_dir <- file.path(proj_dir, "/Results/")
pred_dir <- file.path(proj_dir, "Predictions")
entry_dir <- file.path(proj_dir, "Plant_Material")
fig_dir <- file.path(proj_dir, "Figures")

# Read in cross information
cross_list <- read_excel(file.path(entry_dir, "PopVarVal_cross_info.xlsx")) %>%
  mutate(Cross_no = str_c("4", F1_Pot_No))

# Load the predictions
load(file.path(result_dir, "PVV_post_hoc_prediction_results.RData"))
# Load the observations
load(file.path(result_dir, "PVV_varG_estimates.RData" ))
load(file.path(result_dir, "PVV_rhoG_estimates.RData" ))


```



## Results



Calculate superior progeny mean of the BLUPs

```{r}

i_sp <- 0.10
# All traits will be selected on the lower tail
## Unnest
PVV_family_varG1 <- PVV_family_varG %>% 
  select(trait, family, mu, prog_BLUP) %>% 
  unnest()

PVV_family_musp <- PVV_family_varG1 %>%
  group_by(trait, family) %>%
  mutate(n_ind = n(),
         # Get quantile of i_sp
         i_sp_q = quantile(value, i_sp)) %>%
  filter(value <= i_sp_q) %>%
  summarize(mu_sp = mean(value),
            mu = mean(mu)) %>%
  mutate(mu_sp = mu + mu_sp)

# Remove 0 estimates of the BLUPs
PVV_family_musp_filt <- PVV_family_musp %>% 
  filter(mu_sp != mu) %>%
  gather(metric, estimate, -trait, -family)

# Do not remove
PVV_family_musp <- PVV_family_musp %>% 
  gather(metric, estimate, -trait, -family)

# How many individuals per family
PVV_family_varG1 %>% 
  group_by(family) %>% 
  summarize(fam_size = n_distinct(line_name)) %>%
  arrange(desc(fam_size))

# Number of families per trait
PVV_family_varG1 %>% 
  group_by(trait) %>% 
  summarize(n_fam = n_distinct(family))


```


Visualize the heritability of each train in each family

```{r fam.herit}

(g_family_herit <- PVV_family_varG %>%
  ggplot(aes(x = family, y = H)) + 
  geom_col(fill = "lightblue", col = "black") +
  facet_grid(trait ~ .) +
  ylab("Heritability") +
  xlab("Family") +
  ylim(c(0,1)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  ))

## Save
save_file <- file.path(fig_dir, "family_herit.jpg")
ggsave(filename = save_file, plot = g_family_herit, height = 5, width = 8)



```




Accuracy to Predict Variance and Superior Progeny


```{r var.acc}

# Combine predicted vs observed variances
PVV_varG_comb <- left_join(select(PVV_family_varG, trait, family, varG_hat, H),
                          select(PVV_family_pred, cross:experiment, trait, pred.varG),
                          by = c("trait", "family" = "cross"))

# Function for bootstrapping
cor1 <- function(input.data, i) {
    rep_data <- input.data[i,]
    return(cor(rep_data[,1], rep_data[,2], use = "complete.obs"))
  }

# For each trait, estimate the correlation between predicted and observed VarG
# Use bootstrapping to get a confidence interval
(PVV_varG_acc <- PVV_varG_comb %>% 
  group_by(trait) %>% 
  filter(!is.na(pred.varG)) %>%
  do({
    boot_out <- boot(data = cbind(.$varG_hat, .$pred.varG), statistic = cor1,
                     R = 1000)
    data_frame(statistic = boot_out$t0, se = sd(boot_out$t), 
               bias = mean(boot_out$t) - boot_out$t0,
               ci_lower = quantile(boot_out$t, 0.025),
               ci_upper = quantile(boot_out$t, 0.975),
               n_obs = nrow(boot_out$data)) }))

## Plot
(g_varG_acc <- PVV_varG_comb %>%
  left_join(., PVV_varG_acc) %>%
  ggplot(aes(x = pred.varG, y = varG_hat)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_text(aes(x = Inf, y = -Inf, label = str_c("r = ", round(statistic, 3)), vjust = -1, hjust = 1.5)) +
  ylab("Estimated Genetic Variance") +
  xlab("Predicted Genetic Variance") +
  facet_wrap(~ trait, ncol = 2, scales = "free") +
  theme_bw() +
  labs(
    title = "Genetic Variance Prediction Accuracy"
  ))

## Save
save_file <- file.path(fig_dir, "varG_pred_acc.jpg")
ggsave(filename = save_file, plot = g_varG_acc, height = 5, width = 5)


### Remove unestimatable genetic variances
PVV_varG_comb_filt <- PVV_varG_comb %>%
  filter(varG_hat > 0)

(PVV_varG_acc_filt <- PVV_varG_comb_filt %>% 
  group_by(trait) %>% 
  filter(!is.na(pred.varG)) %>%
  do({
    boot_out <- boot(data = cbind(.$varG_hat, .$pred.varG), statistic = cor1,
                     R = 1000)
    data_frame(statistic = boot_out$t0, se = sd(boot_out$t), 
               bias = mean(boot_out$t) - boot_out$t0,
               ci_lower = quantile(boot_out$t, 0.025),
               ci_upper = quantile(boot_out$t, 0.975),
               n_obs = nrow(boot_out$data)) }))

## Plot
(g_varG_acc_filt <- PVV_varG_comb_filt %>%
  left_join(., PVV_varG_acc_filt) %>%
  ggplot(aes(x = pred.varG, y = varG_hat)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_text(aes(x = Inf, y = -Inf, label = str_c("r = ", round(statistic, 3)), vjust = -1, hjust = 1.5)) +
  ylab("Estimated Genetic Variance") +
  xlab("Predicted Genetic Variance") +
  facet_wrap(~ trait, ncol = 2, scales = "free") +
  theme_bw() +
  labs(
    title = "Genetic Variance Prediction Accuracy",
    caption = "Non-zero genetic variances only."
  ))
   
## Save
save_file <- file.path(fig_dir, "varG_pred_acc_filt.jpg")
ggsave(filename = save_file, plot = g_varG_acc_filt, height = 5, width = 5)



```


Below I removed an obvious leverage point for heading date, however the accuracy was not severely affected, so we will leave it in

```{r lev}

# Remove the leverage point in Heading Date
PVV_varG_comb_filt2 <- PVV_varG_comb_filt %>% 
  filter(trait == "HeadingDate") %>% 
  ungroup() %>% 
  filter(pred.varG < max(pred.varG, na.rm = T)) %>% 
  bind_rows(., filter(PVV_varG_comb_filt, trait != "HeadingDate"))

(PVV_varG_acc_filt2 <- PVV_varG_comb_filt2 %>% 
  group_by(trait) %>% 
  filter(!is.na(pred.varG)) %>%
  do({
    boot_out <- boot(data = cbind(.$varG_hat, .$pred.varG), statistic = cor1,
                     R = 1000)
    data_frame(statistic = boot_out$t0, se = sd(boot_out$t), 
               bias = mean(boot_out$t) - boot_out$t0,
               ci_lower = quantile(boot_out$t, 0.025),
               ci_upper = quantile(boot_out$t, 0.975),
               n_obs = nrow(boot_out$data)) }))

(g_varG_acc_filt2 <- PVV_varG_comb_filt2 %>%
  left_join(., PVV_varG_acc_filt2) %>%
  ggplot(aes(x = pred.varG, y = varG_hat)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_text(aes(x = Inf, y = -Inf, label = str_c("r = ", round(statistic, 3)), vjust = -1, hjust = 1.5)) +
  ylab("Estimated Genetic Variance") +
  xlab("Predicted Genetic Variance") +
  facet_wrap(~ trait, ncol = 2, scales = "free") +
  theme_bw() +
  labs(
    title = "Genetic Variance Prediction Accuracy",
    caption = "Non-zero genetic variances only."
  ))

```









Accuracy to predict superior progeny mean

```{r mu.sp.acc}

# Combine predicted vs observed means
PVV_musp_comb <- left_join(PVV_family_musp, select(PVV_family_pred, cross:experiment, 
                                                   trait, mu = pred.mu, mu_sp = mu.sp_low) %>% 
                             gather(metric, prediction, -cross:-trait),
                          by = c("trait", "family" = "cross", "metric"))

PVV_musp_comb_filt <- left_join(PVV_family_musp_filt, select(PVV_family_pred, cross:experiment, 
                                                   trait, mu = pred.mu, mu_sp = mu.sp_low) %>% 
                             gather(metric, prediction, -cross:-trait),
                          by = c("trait", "family" = "cross", "metric"))


# For each trait, estimate the correlation between predicted and observed VarG
# Use bootstrapping to get a confidence interval
(PVV_musp_acc <- PVV_musp_comb %>% 
  group_by(trait, metric) %>% 
  filter(!is.na(prediction)) %>%
  do({
    boot_out <- boot(data = cbind(.$estimate, .$prediction), statistic = cor1,
                     R = 1000)
    data_frame(statistic = boot_out$t0, se = sd(boot_out$t), 
               bias = mean(boot_out$t) - boot_out$t0,
               ci_lower = quantile(boot_out$t, 0.025),
               ci_upper = quantile(boot_out$t, 0.975),
               n_obs = nrow(boot_out$data)) }))

(PVV_musp_acc_filt <- PVV_musp_comb_filt %>% 
  group_by(trait, metric) %>% 
  filter(!is.na(prediction)) %>%
  do({
    boot_out <- boot(data = cbind(.$estimate, .$prediction), statistic = cor1,
                     R = 1000)
    data_frame(statistic = boot_out$t0, se = sd(boot_out$t), 
               bias = mean(boot_out$t) - boot_out$t0,
               ci_lower = quantile(boot_out$t, 0.025),
               ci_upper = quantile(boot_out$t, 0.975),
               n_obs = nrow(boot_out$data)) }))



## Plot
(g_mu_sp_acc <- PVV_musp_comb %>%
  left_join(., PVV_musp_acc) %>%
  ggplot(aes(x = prediction, y = estimate)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_text(aes(x = Inf, y = -Inf, label = str_c("r = ", round(statistic, 3)), vjust = -1, hjust = 1.5)) +
  ylab("Estimate") +
  xlab("Prediction") +
  facet_wrap(trait ~ metric, ncol = 2, scales = "free") +
  theme_bw())

## Save
save_file <- file.path(fig_dir, "mu_sp_pred_acc.jpg")
ggsave(filename = save_file, plot = g_mu_sp_acc, height = 5, width = 5)


## Plot
(g_mu_sp_acc_filt <- PVV_musp_comb_filt %>%
  left_join(., PVV_musp_acc_filt) %>%
  ggplot(aes(x = prediction, y = estimate)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_text(aes(x = Inf, y = -Inf, label = str_c("r = ", round(statistic, 3)), vjust = -1, hjust = 1.5)) +
  ylab("Estimate") +
  xlab("Prediction") +
  facet_wrap(trait ~ metric, ncol = 2, scales = "free") +
  theme_bw())

## Save
save_file <- file.path(fig_dir, "mu_sp_pred_acc_filt.jpg")
ggsave(filename = save_file, plot = g_mu_sp_acc_filt, height = 5, width = 5)

# Combine
PVV_acc_comb <- PVV_varG_comb %>%
  select(trait, family, estimate = varG_hat, prediction = pred.varG, names(.)) %>% 
  mutate(metric = "varG") %>%
  bind_rows(., PVV_musp_comb) %>%
  select(trait, family, metric, names(.)) %>%
  ungroup()

# Combine - filtered only
PVV_acc_comb_filt <- PVV_varG_comb_filt %>%
  select(trait, family, estimate = varG_hat, prediction = pred.varG, names(.)) %>% 
  mutate(metric = "varG") %>%
  bind_rows(., PVV_musp_comb_filt) %>%
  select(trait, family, metric, names(.)) %>%
  ungroup()

# SAve
save_file <- file.path(result_dir, "PVV_pred_est_combined.RData")
save("PVV_acc_comb", "PVV_acc_comb_filt", file = save_file)

```

Calculate and plot accuracy for all metrics

```{r acc.comb}
# Measure accuracy
(PVV_acc_comb_summ <- PVV_acc_comb %>% 
  group_by(trait, metric) %>% 
  filter(!is.na(prediction)) %>%
  do({
    boot_out <- boot(data = cbind(.$estimate, .$prediction), statistic = cor1,
                     R = 1000)
    data_frame(statistic = boot_out$t0, se = sd(boot_out$t), 
               bias = mean(boot_out$t) - boot_out$t0,
               ci_lower = quantile(boot_out$t, 0.025),
               ci_upper = quantile(boot_out$t, 0.975),
               n_obs = nrow(boot_out$data)) }))

# Measure accuracy
(PVV_acc_comb_filt_summ <- PVV_acc_comb_filt %>% 
  group_by(trait, metric) %>% 
  filter(!is.na(prediction)) %>%
  do({
    boot_out <- boot(data = cbind(.$estimate, .$prediction), statistic = cor1,
                     R = 1000)
    data_frame(statistic = boot_out$t0, se = sd(boot_out$t), 
               bias = mean(boot_out$t) - boot_out$t0,
               ci_lower = quantile(boot_out$t, 0.025),
               ci_upper = quantile(boot_out$t, 0.975),
               n_obs = nrow(boot_out$data)) }))

## This doesn't really affect the analysis

## Plot
(g_acc_comb <- PVV_acc_comb %>%
  mutate(metric = str_replace_all(string = metric, c("mu_sp" = "SuperiorProgenyMean", "mu" = "Mean", "varG" = "GeneticVariance")),
         metric = factor(metric, levels = c("Mean", "GeneticVariance", "SuperiorProgenyMean"))) %>%
  ggplot(aes(x = prediction, y = estimate)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  ylab("Estimate") +
  xlab("Prediction") +
  facet_wrap(trait ~ metric, ncol = 3, scales = "free") +
  theme_bw())

# Save
save_file <- file.path(fig_dir, "comb_pred_acc.jpg")
ggsave(filename = save_file, plot = g_acc_comb, height = 8, width = 8)

# Plot filtered
## Plot
(g_acc_comb_filt <- PVV_acc_comb_filt %>%
  mutate(metric = str_replace_all(string = metric, c("mu_sp" = "SuperiorProgenyMean", "mu" = "Mean", "varG" = "GeneticVariance")),
         metric = factor(metric, levels = c("Mean", "GeneticVariance", "SuperiorProgenyMean"))) %>%
  ggplot(aes(x = prediction, y = estimate)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  ylab("Estimate") +
  xlab("Prediction") +
  facet_wrap(trait ~ metric, ncol = 3, scales = "free") +
  theme_bw())

# Save
save_file <- file.path(fig_dir, "comb_pred_acc_filt.jpg")
ggsave(filename = save_file, plot = g_acc_comb_filt, height = 8, width = 8)



```


Measure the accuracy to predict genetic correlations


```{r gen.cor.acc}

# Combine predicted vs observed correlations
PVV_rhoG_comb <- left_join(PVV_family_rhoG, select(PVV_family_pred, cross:experiment, 
                                                   trait1 = trait, HeadingDate = `cor_w/_HeadingDate`, 
                                                   FHBSeverity = `cor_w/_FHBSeverity`, PlantHeight = `cor_w/_PlantHeight`) %>% 
                             gather(trait2, pred_rhoG, -cross:-trait1) %>% 
                             filter(!is.na(pred_rhoG)), by = c("trait1", "trait2", "family" = "cross"))

# For each trait pair, estimate the correlation between predicted and observed VarG
# Use bootstrapping to get a confidence interval
(PVV_rhoG_acc <- PVV_rhoG_comb %>% 
  group_by(trait1, trait2) %>% 
  do({
    boot_out <- boot(data = cbind(.$rhoG, .$pred_rhoG), statistic = cor1,
                     R = 1000)
    data_frame(statistic = boot_out$t0, se = sd(boot_out$t), 
               bias = mean(boot_out$t) - boot_out$t0,
               ci_lower = quantile(boot_out$t, 0.025),
               ci_upper = quantile(boot_out$t, 0.975),
               n_obs = nrow(boot_out$data)) }))

# Save the data



## Plot
(g_rhoG_acc <- PVV_rhoG_comb %>%
  left_join(., PVV_rhoG_acc) %>%
  ggplot(aes(x = pred_rhoG, y = rhoG)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_text(aes(x = Inf, y = Inf, label = str_c("r = ", round(statistic, 3)), vjust = 1.1, hjust = 1.1)) +
  ylab("Estimated Genetic Correlation") +
  xlab("Predicted Genetic Correlation") +
  facet_wrap(trait1 ~ trait2, scales = "free", ncol = 2) +
  theme_bw() +
  labs(
    title = "Genetic Correlation Prediction Accuracy"
  ))

## Save
save_file <- file.path(fig_dir, "rhoG_pred_acc.jpg")
ggsave(filename = save_file, plot = g_rhoG_acc, height = 5, width = 5)







## Table output for prediction accuracies



```




Explore the data

```{r range}

load(file.path(result_dir, "PVV_pred_est_combined.RData"))

# Combine predicted vs observed correlations
PVV_rhoG_comb <- left_join(PVV_family_rhoG, select(PVV_family_pred, cross:experiment, 
                                                   trait1 = trait, HeadingDate = `cor_w/_HeadingDate`, 
                                                   FHBSeverity = `cor_w/_FHBSeverity`, PlantHeight = `cor_w/_PlantHeight`) %>% 
                             gather(trait2, pred_rhoG, -cross:-trait1) %>% 
                             filter(!is.na(pred_rhoG)), by = c("trait1", "trait2", "family" = "cross"))


# What is the range of estimated and predicted genetic variances?
(range_varG_estimates <- PVV_acc_comb %>% 
  select(trait:prediction) %>%
  gather(type, value, -trait:-metric) %>%
  filter(value > 0) %>%
  group_by(trait, metric, type) %>% 
  summarize_at(vars(value), funs(min, max), na.rm = T) %>%
  mutate(fold = max / min))

PVV_rhoG_comb %>% 
  ungroup() %>%
  unite(col = "trait_pair", trait1, trait2, sep = "_") %>%
  select(family, trait_pair, estimate = rhoG, prediction = pred_rhoG) %>% 
  gather(type, value, -family:-trait_pair) %>%
  filter(value > -0.99999, value < 0.9999999) %>%
  group_by(trait_pair, type) %>% 
  summarize_at(vars(value), funs(min, max), na.rm = T) %>%
  mutate(fold = max / min)



```




