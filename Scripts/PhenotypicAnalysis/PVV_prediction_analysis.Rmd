---
title: "PopVarVal Prediction Analysis"
date: "`r Sys.Date()`"
output: 
  html_notebook:
    toc: true
bibliography: C:/Users/Jeff/Documents/Literature/library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This notebook will include analysis of the predictions produced by PopVar for the different traits across all possible families

```{r load.packages}

# Load packages and set directories

library(tidyverse)
library(lme4)
library(modelr)
library(readxl)
library(stringr)
library(broom)
library(purrrlyr)

# Project directory
proj_dir <- "C:/Users/Jeff/Google Drive/Barley Lab/Projects/PopVarVal/"

proj_pheno_dir <- file.path(proj_dir, "Phenotype_Data")
result_dir <- file.path(proj_dir, "Results")
pred_dir <- file.path(proj_dir, "Predictions")
fig_dir <- file.path(proj_dir, "Figures")

# Phenotypic data directory
pheno_dir <- "C:/Users/Jeff/Google Drive/Barley Lab/Projects/Genomic Selection/Phenotypic Data/Final/2017/"


# Entry information
pvv_train <- read_excel(path = file.path(proj_dir, "Plant_Material/PopVarVal_project_entries.xlsx"))

# Training pop
tp <- pvv_train %>% 
  filter(Purpose == "S2TP") %>%
  pull(Line)

# Checks
train_checks <- pvv_train %>% 
  filter(Purpose == "Check_set1") %>% 
  pull(Line)

pvv_entry <- read_excel(path = file.path(proj_dir, "Plant_Material/PopVarVal_project_entries.xlsx"),
                        sheet = "Entries")

# Separate by check, parent, and entry
checks <- pvv_entry %>% 
  filter(Purpose == "Check_set2") %>% 
  pull(Line)

parents <- pvv_entry %>% 
  filter(Purpose == "Parent") %>% 
  pull(Line)

entries <- pvv_entry %>% 
  filter(Purpose == "Experimental") %>% 
  pull(Line)

# Load the predictions
load(file.path(result_dir, "PVV_prediction_results.RData"))


```



## Results

Plot distributions of the predicted means, variances, and superior progeny means per trait

```{r plot.pred.dist}

# Tidy up
PVV_all_pred_tidy <- PVV_all_pred %>% 
    select(cross:parent2, trait, pred.mu, pred.varG, mu.sp_low, mu.sp_high) %>% 
    mutate(cross_type = if_else(is.na(cross), "unselected", "selected"), 
           mu_sp = if_else(trait == "GrainYield", mu.sp_high, mu.sp_low)) %>% 
  select(-contains("mu.sp")) %>%
  gather(metric, value, -cross:-trait, -cross_type)

# How many crosses were predicted?
n_pred_crosses <- n_distinct(distinct(PVV_all_pred_tidy, parent1, parent2))



g_pred_dist <- PVV_all_pred_tidy %>% 
  filter(!is.na(trait)) %>%
  ggplot(aes(x = value)) +
  geom_histogram() +
  geom_point(data = filter(PVV_all_pred_tidy, cross_type == "selected", !is.na(trait)), 
             aes(x = value, y = 20000, col = "Selected")) +
  facet_wrap(metric ~ trait, scales = "free_x", ncol = 6) +
  scale_color_brewer(palette = "Set1", guide = guide_legend(title = "")) +
  theme_bw() +
  theme(axis.text = element_text(size = 8),
        axis.title = element_blank(),
        legend.position = "bottom") +
  labs(title = "Distribution of Predicted Values",
       caption = str_c("Predictions of n = ", n_pred_crosses, " crosses."))

## Save
save_file <- file.path(fig_dir, "prediction_distributions.jpg")
ggsave(filename = save_file, plot = g_pred_dist, height = 8, width = 8, dpi = 500)


```


Plot the relationship between predicted mean and predicted variance

```{r pred.mu+pred.varG}

# For each trait, plot the relationship between the predicted mean and variance
PVV_all_mu_varG_tidy <- PVV_all_pred_tidy %>% 
  filter(metric %in% c("pred.mu", "pred.varG")) %>% 
  spread(metric, value) %>%
  filter(!is.na(trait))

g_pred_mu_varG <- PVV_all_mu_varG_tidy %>% 
  ggplot(aes(x = pred.mu, y = pred.varG)) +
  geom_point() + 
  geom_point(data = filter(PVV_all_mu_varG_tidy, cross_type == "selected"),
             aes(col = "Selected")) +
  ylab("Predicted Mean") +
  xlab("Predicted Genetic Variance") +
  facet_wrap(~ trait, scales = "free", ncol = 3) +
  scale_color_brewer(palette = "Set1", guide = guide_legend(title = "")) +
  theme_bw() + 
  theme(legend.position = "bottom") +
  labs(title = "Relationship Between the Predicted Mean and Genetic Variance",
       caption = str_c("Predictions of n = ", n_pred_crosses, " crosses."))
  

## Save
save_file <- file.path(fig_dir, "prediction_mu_and_varG.jpg")
ggsave(filename = save_file, plot = g_pred_mu_varG, height = 6, width = 8, dpi = 500)



```


Plot the distribution of correlations between different traits


```{r pred.corr}

# Tidy up
PVV_all_pred_corr_tidy <- PVV_all_pred %>% 
  select(cross:parent2, trait, contains("cor")) %>% 
  rename_all(funs(str_replace_all(., pattern = "cor_w/_", ""))) %>% 
  gather(trait2, correlation, -cross:-trait) %>%
  filter(!is.na(correlation)) %>%
  mutate(cross_type = if_else(is.na(cross), "unselected", "selected"))

# Plot
g_pred_corr_dist <- PVV_all_pred_corr_tidy %>% 
  ggplot(aes(x = correlation)) +
  geom_histogram() +
  geom_point(data = filter(PVV_all_pred_corr_tidy, cross_type == "selected"), 
             aes(x = correlation, y = 20000, col = "Selected")) +
  xlab("Genetic Correlation") +
  facet_grid(trait ~ trait2) +
  scale_color_brewer(palette = "Set1", guide = guide_legend(title = "")) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1),
        axis.title.y = element_blank(),
        strip.text = element_text(size = 8),
        legend.position = "bottom") +
  labs(title = "Distribution of Predicted Genetic Correlations",
       caption = str_c("Predictions of n = ", n_pred_crosses, " crosses."))

save_file <- file.path(fig_dir, "prediction_correlation_distributions.jpg")
ggsave(filename = save_file, plot = g_pred_corr_dist, height = 8, width = 8, dpi = 500)

```







## Discussion

Some interpretation

## References